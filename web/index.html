<!DOCTYPE html>
<html lang="en" class="bg-gray-100">
<head>
    <meta charset="UTF-8"/>
    <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
    <title>Spy Parser</title>
    <link rel="stylesheet" href="/src/style.css"/>
</head>

<body class="min-h-screen p-6" x-data="appModel()" x-init="init()">
<div class="max-w-4xl mx-auto bg-white p-6 rounded-xl shadow-md">
    <h1 class="text-2xl font-bold mb-4">Ranked War Matchmaker</h1>

    <textarea
            x-model="input"
            x-debounced-persist
            class="w-full h-48 p-3 border rounded resize-none mb-4"
            placeholder="Paste spy reports here..."
    ></textarea>

    <div class="flex gap-4 mb-4">
        <button
                @click="parse()"
                class="bg-blue-600 text-white px-4 py-2 rounded hover:bg-blue-700"
        >
            Parse
        </button>
        <button
                @click="clear()"
                class="bg-gray-300 text-gray-800 px-4 py-2 rounded hover:bg-gray-400"
        >
            Clear
        </button>
    </div>

    <template x-if="spies.length">
        <div class="overflow-x-auto">
            <template x-if="hasInvalidStats()">
                <div class="mb-4 p-3 rounded border border-yellow-400 bg-yellow-100 text-yellow-900 text-sm">
                    ⚠️ Targets with missing or invalid battle stat values will not be matched.
                </div>
            </template>
            <table class="table-auto w-full border border-gray-300 text-sm">
                <thead class="bg-gray-200">
                <tr>
                    <th class="border p-2">Name</th>
                    <th class="border p-2">Level</th>
                    <th class="border p-2">Speed</th>
                    <th class="border p-2">Strength</th>
                    <th class="border p-2">Defense</th>
                    <th class="border p-2">Dexterity</th>
                    <th class="border p-2">Total</th>
                </tr>
                </thead>
                <tbody>
                <template x-for="(spy, i) in spies" :key="i">
                    <tr>
                        <td class="border p-2"><input x-model="spy.name" x-debounced-persist class="w-full border rounded p-1"/></td>
                        <td class="border p-2"><input x-model="spy.level" x-debounced-persist class="w-full border rounded p-1"/></td>
                        <td class="border p-2">
                            <input
                                    x-model="spy.speed" x-debounced-persist
                                    :class="isInvalid(spy.speed) ? 'border-red-500 bg-red-50' : 'border-gray-300'"
                                    class="w-full border rounded p-1"
                            />
                        </td>
                        <td class="border p-2">
                            <input
                                    x-model="spy.strength" x-debounced-persist
                                    :class="isInvalid(spy.strength) ? 'border-red-500 bg-red-50' : 'border-gray-300'"
                                    class="w-full border rounded p-1"
                            />
                        </td>
                        <td class="border p-2">
                            <input
                                    x-model="spy.defense" x-debounced-persist
                                    :class="isInvalid(spy.defense) ? 'border-red-500 bg-red-50' : 'border-gray-300'"
                                    class="w-full border rounded p-1"
                            />
                        </td>
                        <td class="border p-2">
                            <input
                                    x-model="spy.dexterity" x-debounced-persist
                                    :class="isInvalid(spy.dexterity) ? 'border-red-500 bg-red-50' : 'border-gray-300'"
                                    class="w-full border rounded p-1"
                            />
                        </td>

                        <td class="border p-2">
                            <input
                                    class="w-full border rounded p-1 bg-gray-100 text-gray-700"
                                    :value="formatTotal(spy)"
                                    readonly
                            />
                        </td>
                    </tr>
                </template>
                </tbody>
            </table>
        </div>
    </template>
</div>

<!-- Define app model BEFORE Alpine starts -->
<script type="module">
    import { newAppModel } from './src/app_model.js'
    window.appModel = newAppModel
</script>


<!-- Load and start Alpine AFTER app model is defined -->
<script type="module">
    import Alpine from 'alpinejs'

    Alpine.directive('debounced-persist', (el, { expression }, { evaluate }) => {
        el.addEventListener('input', () => {
            // Evaluate 'debouncedPersist' in component scope
            const fn = evaluate(expression || 'debouncedPersist');
            fn?.();
        });
    });

    window.Alpine = Alpine
    Alpine.start()
</script>
</body>
</html>
