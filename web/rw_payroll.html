<!DOCTYPE html>
<html lang="en" class="bg-background">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Ranked War Payroll</title>
    <link rel="stylesheet" href="./src/style.css" />
</head>
<body class="min-h-screen p-6 text-textPrimary bg-background" x-data="payrollModel()" x-init="init()">
<div class="max-w-2xl mx-auto bg-surface p-6 rounded-xl shadow-md">
    <h1 class="text-2xl font-bold mb-4">Ranked War Payroll</h1>

    <!-- API Key input -->
    <template x-if="!apiKey">
        <div>
            <label class="block mb-2 font-medium">Torn API Key</label>
            <input
                    x-model="apiKeyInput"
                    type="text"
                    class="w-full border border-border rounded p-2 mb-4"
                    placeholder="Paste your Torn API key here"
            />
            <button
                    @click="saveApiKey"
                    :disabled="!apiKeyInput"
                    class="bg-accent text-white px-4 py-2 rounded hover:bg-accentHover disabled:opacity-50"
            >
                Save API Key
            </button>
        </div>
    </template>

    <!-- Ranked Wars selector -->
    <template x-if="apiKey && rankedWars.length">
        <div>
            <label class="block mb-2 font-medium">Select Ranked War</label>
            <select x-model="selectedWarId" class="w-full border border-border rounded p-2 mb-4">
                <option value="" disabled>Select a war...</option>
                <template x-for="war in rankedWars" :key="war.id">
                    <option :value="war.id" x-text="war.opposingFactionName"></option>
                </template>
            </select>
        </div>
    </template>

    <!-- Profit / Costs inputs -->
    <template x-if="selectedWarId">
        <div class="space-y-4">
            <div>
                <label class="block mb-2 font-medium">Profit ($)</label>
                <input
                        x-model="profitInput"
                        inputmode="numeric"
                        @blur="validateProfit"
                        :class="isProfitInvalid ? 'border-dangerText' : 'border-border'"
                        class="w-full rounded p-2"
                        placeholder="Enter profit amount"
                />
            </div>

            <div>
                <label class="block mb-2 font-medium">Costs ($)</label>
                <input
                        x-model="costsInput"
                        inputmode="numeric"
                        @blur="validateCosts"
                        :class="isCostsInvalid ? 'border-dangerText' : 'border-border'"
                        class="w-full rounded p-2"
                        placeholder="Enter costs amount"
                />
            </div>

            <div>
                <label class="block mb-2 font-medium">Faction Take (%)</label>
                <input
                        x-model.number="factionTake"
                        type="number"
                        min="0"
                        max="100"
                        @blur="validateFactionTake"
                        :class="isFactionTakeInvalid ? 'border-dangerText' : 'border-border'"
                        class="w-full rounded p-2"
                        placeholder="e.g., 25 for 25%"
                />
            </div>

            <div>
                <label class="block mb-2 font-medium">Outside Hit Value (%)</label>
                <input
                        x-model.number="outsideHitValue"
                        type="number"
                        min="0"
                        max="100"
                        @blur="validateOutsideHit"
                        :class="isOutsideHitInvalid ? 'border-dangerText' : 'border-border'"
                        class="w-full rounded p-2"
                        placeholder="e.g., 50 for 50%"
                />
            </div>

        </div>
    </template>

    <!-- Generate Report button -->
    <template x-if="selectedWarId">
        <div class="mt-4">
            <button
                    @click="generateReport"
                    :disabled="!canGenerateReport()"
                    class="bg-accent text-white px-4 py-2 rounded hover:bg-accentHover disabled:opacity-50"
            >
                Generate Report
            </button>
        </div>
    </template>

    <!-- Audit Log toggle -->
    <template x-if="report.length">
        <div class="mt-4 flex justify-end">
            <button
                    @click="showAudit = !showAudit"
                    class="px-4 py-2 rounded bg-muted hover:bg-border text-sm"
            >
                <span x-text="showAudit ? 'Show Summary' : 'Show Audit Log'"></span>
            </button>
        </div>
    </template>

    <!-- Report output -->
    <template x-if="report.length && !showAudit">
        <div class="mt-6 overflow-x-auto">
            <table class="table-auto w-full border border-border text-sm">
                <thead class="bg-muted">
                <tr>
                    <th class="border border-border p-2 text-left">Player</th>
                    <th class="border border-border p-2 text-right">War Hits</th>
                    <th class="border border-border p-2 text-right">Outside Hits</th>
                    <th class="border border-border p-2 text-right">Effective Hits</th>
                    <th class="border border-border p-2 text-right">Payout ($)</th>
                </tr>
                </thead>
                <tbody>
                <template x-for="row in report" :key="row.id">
                    <tr>
                        <td class="border border-border p-2" x-text="row.name"></td>
                        <td class="border border-border p-2 text-right" x-text="row.warHits"></td>
                        <td class="border border-border p-2 text-right" x-text="row.outsideHits"></td>
                        <td class="border border-border p-2 text-right" x-text="row.effectiveHits.toFixed(2)"></td>
                        <td class="border border-border p-2 text-right" x-text="formatCurrency(row.payout)"></td>
                    </tr>
                </template>
                </tbody>
            </table>

            <div class="mt-4 flex gap-2 justify-end">
                <button
                        @click="exportReportAsCSV"
                        class="px-3 py-2 rounded bg-muted hover:bg-border text-sm"
                >
                    Export CSV
                </button>
                <button
                        @click="exportReportAsText"
                        class="px-3 py-2 rounded bg-muted hover:bg-border text-sm"
                >
                    Export Plain Text
                </button>
            </div>
        </div>
    </template>

    <!-- Audit Log output -->
    <template x-if="showAudit && auditLog.length">
        <div class="mt-6 overflow-x-auto">
            <table class="table-auto w-full border border-border text-sm">
                <thead class="bg-muted">
                <tr>
                    <th class="border border-border p-2 text-left">Attacker</th>
                    <th class="border border-border p-2 text-left">Type</th>
                    <th class="border border-border p-2 text-left">Opponent</th>
                    <th class="border border-border p-2 text-left">Result</th>
                    <th class="border border-border p-2 text-left">Counted</th>
                    <th class="border border-border p-2 text-left">Timestamp</th>
                </tr>
                </thead>
                <tbody>
                <template x-for="(entry, i) in auditLog" :key="i">
                    <tr :class="{
                      'bg-successBg text-successText': entry.counted,
                      'bg-dangerBg text-dangerText': !entry.isAttackerFacMember && !entry.counted
                    }">
                    <td class="border border-border p-2" x-text="entry.player"></td>
                        <td class="border border-border p-2" x-text="entry.type"></td>
                        <td class="border border-border p-2" x-text="entry.opponent"></td>
                        <td class="border border-border p-2" x-text="entry.result"></td>
                        <td class="border border-border p-2" x-text="entry.counted ? 'Yes' : 'No'"></td>
                        <td class="border border-border p-2" x-text="entry.timestamp"></td>
                    </tr>
                </template>
                </tbody>
            </table>
        </div>
    </template>

    <!-- Loading state -->
    <template x-if="isLoading">
        <div class="text-sm text-textSecondary mt-4">
            <span class="animate-spin inline-block w-4 h-4 border-2 border-border border-t-transparent rounded-full mr-2"></span>
            Fetching ranked wars...
        </div>
    </template>

    <!-- Error state -->
    <template x-if="error">
        <div class="mt-2 p-3 rounded border border-red-400 bg-red-100 text-red-800 text-sm">
            ‚ùå <div x-text="error"></div>
        </div>
    </template>

</div>

<script type="module">
    import Alpine from 'alpinejs'
    import { newTornApiClient, collectRankedWarHitsFromData } from './src/torn_api.js'

    window.Alpine = Alpine

    Alpine.data('payrollModel', () => ({
        apiKey: null,
        apiKeyInput: '',
        apiClient: null,
        rankedWars: [],
        selectedWarId: '',
        isLoading: false,
        showAudit: false,
        showNonFacHitsInAudit: false,
        error: '',

        // Payroll inputs
        profit: null,
        costs: null,
        factionTake: null,
        outsideHitValue: null,

        // Parsed Inputs
        profitInput: '',
        costsInput: '',
        isProfitInvalid: false,
        isCostsInvalid: false,
        isFactionTakeInvalid: false,
        isOutsideHitInvalid: false,

        // Report output
        report: [],
        auditLog: [],

        init() {
            this.apiKey = localStorage.getItem('tornApiKey')
            if (this.apiKey) {
                this.setupApiClient()
                this.fetchRankedWars()
            }
        },

        saveApiKey() {
            if (!this.apiKeyInput) return
            this.apiKey = this.apiKeyInput
            localStorage.setItem('tornApiKey', this.apiKey)
            this.setupApiClient()
            this.fetchRankedWars()
        },

        setupApiClient() {
            this.apiClient = newTornApiClient(this.apiKey, fetch, 'https://api.torn.com/v2')
        },

        async fetchRankedWars() {
            this.isLoading = true
            this.error = ''
            try {
                const factionId = 49297 // Shaggy Hi-Fidelity
                const result = await this.apiClient.fetchRankedWars(factionId)
                this.rankedWars = Object.entries(result.rankedwars).map(([id, war]) => ({
                    id: war.id,
                    start: war.start,
                    end: war.end,
                    factions: war.factions,
                    opposingFactionId: war.factions.find(f => f.id !== factionId)?.id || null,
                    opposingFactionName: war.factions.find(f => f.id !== factionId)?.name || 'Unknown Faction',
                }))
            } catch (err) {
                console.error(err)
                this.error = 'Failed to fetch ranked wars.'
            } finally {
                this.isLoading = false
            }
        },

        canGenerateReport() {
            const profit = this.parseNumber(this.profitInput);
            const costs = this.parseNumber(this.costsInput);
            return (
                this.selectedWarId &&
                profit != null &&
                costs != null &&
                this.factionTake != null &&
                this.outsideHitValue != null
            );
        },

        parseNumber(value) {
            if (!value) return null;
            const cleaned = value
                .replace(/^\s*\$/, '')  // remove optional leading $ and whitespace
                .replace(/,/g, '');     // remove commas
            const num = parseFloat(cleaned);
            return isNaN(num) ? null : num;
        },

        formatCurrency(value) {
            return `$${value.toLocaleString()}`
        },

        validateProfit() {
            const profit = this.parseNumber(this.profitInput);
            this.isProfitInvalid = profit === null;
        },

        validateCosts() {
            const costs = this.parseNumber(this.costsInput);
            this.isCostsInvalid = costs === null;
        },

        validateFactionTake() {
            const val = this.factionTake;
            this.isFactionTakeInvalid = val == null || val < 0 || val > 100;
        },

        validateOutsideHit() {
            const val = this.outsideHitValue;
            this.isOutsideHitInvalid = val == null || val < 0 || val > 100;
        },

        async generateReport() {
            this.isLoading = true
            this.error = ''
            this.report = []

            const profit = this.parseNumber(this.profitInput);
            const costs = this.parseNumber(this.costsInput);

            if (profit == null || costs == null) {
                this.error = 'Invalid input values';
                this.isLoading = false;
                return;
            }

            try {
                const factionId = 49297
                const rankedWar = this.rankedWars.find(w => w.id == this.selectedWarId)
                const { start, end } = rankedWar;
                const attacks = await this.apiClient.fetchAttacksInWindow(start, end);
                const { participants, auditLog } = collectRankedWarHitsFromData(rankedWar, attacks, factionId);

                // Translate audit log timestamps to readable format
                this.auditLog = auditLog.map(e => ({
                    ...e,
                    timestamp: new Date(e.timestamp * 1000).toLocaleString()
                }));

                if (!this.showNonFacHitsInAudit) {
                    this.auditLog = this.auditLog.filter(e => e.isAttackerFacMember);
                }

                // Compute effective hits and total
                let totalEffectiveHits = 0
                const playerStats = participants.map(p => {
                    const warHits = p.warHits.length
                    const outsideHits = p.outsideHits.length
                    const effectiveHits = warHits + outsideHits * (this.outsideHitValue / 100)
                    totalEffectiveHits += effectiveHits
                    return {
                        id: p.id,
                        name: p.name,
                        warHits,
                        outsideHits,
                        effectiveHits
                    }
                })

                const netProfit = profit - costs;
                const factionPayout = netProfit * (this.factionTake / 100);
                const playersPayout = netProfit - factionPayout;

                // Apportion payouts
                this.report = playerStats.map(p => ({
                    ...p,
                    payout: totalEffectiveHits > 0 ? Math.round(playersPayout * (p.effectiveHits / totalEffectiveHits)) : 0
                }))

            } catch (err) {
                console.error(err)
                this.error = 'Failed to generate report.'
            } finally {
                this.isLoading = false
            }
        },

        exportReportAsCSV() {
            if (!this.report.length) return;

            const headers = ['Player', 'War Hits', 'Outside Hits', 'Effective Hits', 'Payout ($)'];
            const rows = this.report.map(r =>
                [
                    `"${r.name}"`,
                    r.warHits,
                    r.outsideHits,
                    r.effectiveHits.toFixed(2),
                    r.payout
                ].join(',')
            );

            const csvContent = [headers.join(','), ...rows].join('\n');
            this.downloadFile('payroll_summary.csv', csvContent, 'text/csv');
        },

        exportReportAsText() {
            if (!this.report.length) return;

            const lines = this.report.map(r =>
                `${r.name}: ${r.warHits} war hits, ${r.outsideHits} outside hits, ${r.effectiveHits.toFixed(2)} effective hits, $${r.payout.toLocaleString()}`
            );

            const content = lines.join('\n');
            this.downloadFile('payroll_summary.txt', content, 'text/plain');
        },

        downloadFile(filename, content, mimeType) { // TODO move to utils
            const blob = new Blob([content], { type: mimeType });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = filename;
            a.click();
            URL.revokeObjectURL(url);
        },

    }))

    Alpine.start()
</script>
</body>
</html>
